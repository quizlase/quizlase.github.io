/**
 * SEO-optimerad URL Handler f√∂r Quizla
 * Anv√§nder riktiga URL:er (/quiz/disney) ist√§llet f√∂r hash (#quiz=Disney)
 * Kompatibel med Umami Analytics och SEO
 */
class SEOURLHandler {
    constructor(app) {
        this.app = app;
        this.setupPopStateListener();
        this.setupInitialRoute();
        console.log('‚úÖ SEO URL Handler initialiserad');
    }

    /**
     * Hantera initial routing n√§r sidan laddas
     */
    setupInitialRoute() {
        const path = window.location.pathname;
        const searchParams = new URLSearchParams(window.location.search);
        
        if (path === '/' || path === '') {
            // Kolla om det finns quiz-parameter i URL
            const quizParam = searchParams.get('quiz');
            if (quizParam) {
                console.log('üîÑ Hittade quiz-parameter:', quizParam);
                this.handleQuizRoute(quizParam);
            }
            return;
        }

        // Hantera /quiz/[kategori] format
        if (path.startsWith('/quiz/')) {
            const category = path.substring(7); // Ta bort '/quiz/'
            this.handleQuizRoute(category);
        }
        // Hantera andra specialrutter
        else if (path === '/blanda') {
            this.app.selectCategory('blandad');
        }
        else if (path === '/fler-quiz') {
            this.app.showView('fler-quiz');
        }
        else if (path === '/installningar') {
            this.app.showView('settings');
        }
    }

    /**
     * Hantera quiz-rutter
     */
    async handleQuizRoute(categorySlug) {
        console.log(`üîÑ Hanterar quiz-route: ${categorySlug}`);

        // F√∂rst kolla standardkategorier
        if (await this.tryStandardCategory(categorySlug)) {
            return;
        }

        // Sedan kolla dynamiska kategorier
        if (await this.tryDynamicCategory(categorySlug)) {
            return;
        }

        // Om inget hittades, g√• tillbaka till hemsidan
        console.log(`‚ùå Quiz "${categorySlug}" hittades inte`);
        this.redirectToHome();
    }

    /**
     * F√∂rs√∂k starta standardkategori
     */
    async tryStandardCategory(categorySlug) {
        const standardCategories = {
            'sport': 'sport',
            'musik': 'musik',
            'geografi': 'geografi',
            'film': 'film',
            'teknik': 'teknik',
            'allmanbildning': 'allmanbildning'
        };

        const normalizedSlug = this.normalizeCategorySlug(categorySlug);
        
        if (standardCategories[normalizedSlug]) {
            const categoryKey = standardCategories[normalizedSlug];
            console.log(`‚úÖ Startar standardkategori: ${categoryKey}`);
            
            // Uppdatera meta-taggar f√∂r SEO
            this.updateCategoryMetaTags(categoryKey, this.getStandardCategoryName(categoryKey));
            
            // Starta quiz
            this.app.selectCategory(categoryKey);
            return true;
        }

        return false;
    }

    /**
     * F√∂rs√∂k starta dynamisk kategori
     */
    async tryDynamicCategory(categorySlug) {
        if (typeof AVAILABLE_QUIZ === 'undefined') {
            console.error('AVAILABLE_QUIZ inte laddad');
            return false;
        }

        // Hitta kategori baserat p√• slug
        const quiz = AVAILABLE_QUIZ.find(q => {
            const quizSlug = this.generateCategorySlug(q.name);
            return quizSlug === categorySlug;
        });

        if (!quiz) {
            return false;
        }

        try {
            console.log(`üîÑ Laddar dynamisk quiz: ${quiz.name}`);
            
            // Ladda CSV-fil
            const response = await fetch(`data/kategori/${quiz.file}`);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const csvText = await response.text();
            const questions = this.app.parseCSV(csvText);

            if (questions.length === 0) {
                throw new Error('Inga giltiga fr√•gor hittades');
            }

            // Uppdatera meta-taggar f√∂r SEO
            this.updateCategoryMetaTags(quiz.key, quiz.name);

            // Starta quiz
            this.startDynamicQuiz(quiz, questions);
            return true;

        } catch (error) {
            console.error(`‚ùå Kunde inte ladda quiz "${quiz.name}":`, error);
            return false;
        }
    }

    /**
     * Starta dynamiskt quiz
     */
    startDynamicQuiz(quiz, questions) {
        this.app.selectedCategory = quiz.key;
        this.app.shuffledQuestions = this.app.shuffleArray(questions);
        this.app.currentQuestionIndex = 0;
        this.app.showAnswer = this.app.settings.alwaysShowAnswer;
        this.app.selectedAnswer = null;

        // Reset score
        this.app.resetScore();

        // Update UI
        document.getElementById('category-title').textContent = quiz.name;
        this.app.showView('quiz');
        this.app.loadCurrentQuestion(true);

        console.log(`‚úÖ Quiz "${quiz.name}" startad med ${questions.length} fr√•gor`);
    }

    /**
     * Generera URL f√∂r kategori
     */
    generateCategoryURL(categoryName) {
        const slug = this.generateCategorySlug(categoryName);
        return `/quiz/${slug}`;
    }

    /**
     * Generera slug f√∂r kategori
     */
    generateCategorySlug(categoryName) {
        return categoryName.toLowerCase()
            .replace(/[√•√§√∂]/g, (match) => {
                return { '√•': 'a', '√§': 'a', '√∂': 'o' }[match];
            })
            .replace(/\s+/g, '-')
            .replace(/[^a-z0-9-]/g, '');
    }

    /**
     * Normalisera slug f√∂r j√§mf√∂relse
     */
    normalizeCategorySlug(slug) {
        return slug.toLowerCase()
            .replace(/[√•√§√∂]/g, (match) => {
                return { '√•': 'a', '√§': 'a', '√∂': 'o' }[match];
            })
            .replace(/\s+/g, '_')
            .replace(/[^a-z0-9_]/g, '')
            .replace(/_+/g, '_')
            .replace(/^_|_$/g, '');
    }

    /**
     * Uppdatera URL f√∂r kategori
     */
    updateCategoryURL(categoryName) {
        const newURL = this.generateCategoryURL(categoryName);
        
        // Uppdatera URL utan att ladda om sidan
        window.history.pushState({ 
            category: categoryName, 
            type: 'quiz' 
        }, '', newURL);

        // Sp√•ra i Umami Analytics
        this.trackUmamiPageView(categoryName, newURL);

        console.log(`üîó URL uppdaterad till: ${newURL}`);
    }

    /**
     * Uppdatera URL f√∂r specialrutter
     */
    updateSpecialRouteURL(route) {
        const newURL = `/${route}`;
        
        window.history.pushState({ 
            route: route, 
            type: 'special' 
        }, '', newURL);

        // Sp√•ra i Umami Analytics
        this.trackUmamiPageView(route, newURL);

        console.log(`üîó URL uppdaterad till: ${newURL}`);
    }

    /**
     * Uppdatera meta-taggar f√∂r SEO
     */
    updateCategoryMetaTags(categoryKey, categoryName) {
        const categoryData = this.getCategoryMetaData(categoryKey, categoryName);
        
        // Uppdatera sidtitel
        document.title = `${categoryData.title} | Quizla`;
        
        // Uppdatera meta description
        let metaDesc = document.querySelector('meta[name="description"]');
        if (metaDesc) metaDesc.content = categoryData.description;
        
        // Uppdatera keywords
        let metaKeywords = document.querySelector('meta[name="keywords"]');
        if (metaKeywords) metaKeywords.content = categoryData.keywords;
        
        // Uppdatera Open Graph
        let ogTitle = document.querySelector('meta[property="og:title"]');
        if (ogTitle) ogTitle.content = categoryData.title;
        
        let ogDesc = document.querySelector('meta[property="og:description"]');
        if (ogDesc) ogDesc.content = categoryData.description;
        
        // Uppdatera Twitter Cards
        let twitterTitle = document.querySelector('meta[name="twitter:title"]');
        if (twitterTitle) twitterTitle.content = categoryData.title;
        
        let twitterDesc = document.querySelector('meta[name="twitter:description"]');
        if (twitterDesc) twitterDesc.content = categoryData.description;
        
        console.log(`‚úÖ Meta-taggar uppdaterade f√∂r: ${categoryName}`);
    }

    /**
     * H√§mta meta-data f√∂r kategori
     */
    getCategoryMetaData(categoryKey, categoryName) {
        const metaData = {
            'allmanbildning': {
                title: 'Allm√§nbildning Quiz - Testa dina kunskaper',
                description: 'Spela gratis allm√§nbildningsquiz med hundratals fr√•gor. Testa dina kunskaper inom historia, vetenskap, kultur och mycket mer.',
                keywords: 'allm√§nbildning, quiz, historia, vetenskap, kultur, gratis quiz, svenska quiz'
            },
            'musik': {
                title: 'Musik Quiz - Utmana dig sj√§lv inom musik',
                description: 'Musikquiz f√∂r alla! Testa dina kunskaper inom pop, rock, jazz, klassisk musik och mer. Gratis och offline.',
                keywords: 'musik, quiz, pop, rock, jazz, klassisk musik, gratis quiz, svenska musikquiz'
            },
            'geografi': {
                title: 'Geografi Quiz - L√§r dig om v√§rlden',
                description: 'Utforska v√§rlden med v√•rt geografiquiz! Huvudst√§der, l√§nder, berg och hav. Perfekt f√∂r att l√§ra sig geografi.',
                keywords: 'geografi, quiz, huvudst√§der, l√§nder, berg, hav, v√§rlden, gratis quiz'
            },
            'film': {
                title: 'Film & TV Quiz - Testa din filmkunskap',
                description: 'Film & TV-quiz f√∂r film√§lskare! Fr√•gor om Hollywood, svenska filmer, TV-serier och sk√•despelare.',
                keywords: 'film, tv, quiz, hollywood, svenska filmer, tv-serier, sk√•despelare, gratis quiz'
            },
            'sport': {
                title: 'Sport Quiz - Sportfr√•gor f√∂r alla',
                description: 'Sportquiz f√∂r alla idrottsintresserade! Fotboll, hockey, tennis, olympiska spel och mycket mer.',
                keywords: 'sport, quiz, fotboll, hockey, tennis, olympiska spel, gratis quiz, svenska sportquiz'
            },
            'teknik': {
                title: 'Teknik Quiz - Moderna teknikfr√•gor',
                description: 'Teknikquiz f√∂r dig som √§r intresserad av datorer, internet, AI och modern teknologi.',
                keywords: 'teknik, quiz, datorer, internet, ai, teknologi, gratis quiz, svenska teknikquiz'
            }
        };

        // Om det √§r en standardkategori
        if (metaData[categoryKey]) {
            return metaData[categoryKey];
        }

        // Om det √§r en dynamisk kategori, generera generisk data
        return {
            title: `${categoryName} Quiz - Testa dina kunskaper`,
            description: `Spela ${categoryName}-quiz och testa dina kunskaper. Gratis, offline och inga reklamer!`,
            keywords: `${categoryName.toLowerCase()}, quiz, gratis quiz, svenska quiz, offline`
        };
    }

    /**
     * H√§mta standardkategorinamn
     */
    getStandardCategoryName(categoryKey) {
        const names = {
            'sport': 'Sport',
            'musik': 'Musik',
            'geografi': 'Geografi',
            'film': 'Film & TV',
            'teknik': 'Teknik',
            'allmanbildning': 'Allm√§nbildning'
        };
        return names[categoryKey] || categoryKey;
    }

    /**
     * Sp√•ra sidvisning i Umami Analytics
     */
    trackUmamiPageView(categoryName, url) {
        if (typeof umami !== 'undefined') {
            // Sp√•ra som en ny sidvisning
            umami.track('page_view', {
                category: categoryName,
                url: url,
                title: document.title,
                timestamp: new Date().toISOString()
            });
            
            console.log(`üìä Umami sidvisning sp√•rad: ${categoryName} - ${url}`);
        }
    }

    /**
     * Hantera browser back/forward
     */
    setupPopStateListener() {
        window.addEventListener('popstate', (event) => {
            console.log('üîÑ Popstate event:', event.state);
            
            if (event.state && event.state.category) {
                // √Öterst√§ll quiz-state
                this.handleQuizRoute(this.generateCategorySlug(event.state.category));
            } else if (event.state && event.state.route) {
                // √Öterst√§ll specialrutt
                this.handleSpecialRoute(event.state.route);
            } else {
                // G√• tillbaka till hemsidan
                this.app.showView('home');
                this.clearMetaTags();
            }
        });
    }

    /**
     * Hantera specialrutter
     */
    handleSpecialRoute(route) {
        switch (route) {
            case 'blanda':
                this.app.selectCategory('blandad');
                break;
            case 'fler-quiz':
                this.app.showView('fler-quiz');
                break;
            case 'installningar':
                this.app.showView('settings');
                break;
            default:
                this.app.showView('home');
        }
    }

    /**
     * Rensa meta-taggar (tillbaka till standard)
     */
    clearMetaTags() {
        // √Öterst√§ll till standardtitel
        document.title = 'Quizla - Sveriges st√∂rsta Quiz, helt gratis!';
        
        // √Öterst√§ll till standardbeskrivning
        const standardDesc = 'Quizla - Sveriges st√∂rsta quizplattform med tusentals gratis fr√•gor inom allm√§nbildning, sport, musik, film och mycket mer. Spela offline, inga reklamer, helt gratis!';
        
        let metaDesc = document.querySelector('meta[name="description"]');
        if (metaDesc) metaDesc.content = standardDesc;
        
        // √Öterst√§ll Open Graph
        let ogTitle = document.querySelector('meta[property="og:title"]');
        if (ogTitle) ogTitle.content = 'Quizla - Sveriges st√∂rsta Quiz, helt gratis!';
        
        let ogDesc = document.querySelector('meta[property="og:description"]');
        if (ogDesc) ogDesc.content = 'Spela tusentals gratis quiz inom allm√§nbildning, sport, musik, film och mycket mer. Offline-l√§ge, inga reklamer!';
        
        // √Öterst√§ll Twitter Cards
        let twitterTitle = document.querySelector('meta[name="twitter:title"]');
        if (twitterTitle) twitterTitle.content = 'Quizla - Sveriges st√∂rsta Quiz, helt gratis!';
        
        let twitterDesc = document.querySelector('meta[name="twitter:description"]');
        if (twitterDesc) twitterDesc.content = 'Spela tusentals gratis quiz inom allm√§nbildning, sport, musik, film och mycket mer.';
        
        console.log('‚úÖ Meta-taggar √•terst√§llda till standard');
    }

    /**
     * Rensa URL (tillbaka till hemsidan)
     */
    clearURL() {
        window.history.pushState({}, '', '/');
        this.clearMetaTags();
        console.log('‚úÖ URL rensad, √•terg√•r till hemsidan');
    }

    /**
     * Omdirigera till hemsidan
     */
    redirectToHome() {
        window.history.pushState({}, '', '/');
        this.app.showView('home');
        this.clearMetaTags();
    }
}

// Exportera f√∂r anv√§ndning
if (typeof module !== 'undefined' && module.exports) {
    module.exports = SEOURLHandler;
}

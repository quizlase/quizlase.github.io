name: Auto Update Quiz Links
on:
  push:
    paths: 
      - 'data/kategori/*.csv'
      - '.github/workflows/update-quiz-links.yml'
  workflow_dispatch: # TillÃ¥t manuell kÃ¶rning

jobs:
  update-quiz-links:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Create js directory
        run: mkdir -p js
        
      - name: Generate quiz-links.js
        run: |
          cat > js/quiz-links.js << 'EOL'
          // Auto-generated quiz list - DO NOT EDIT MANUALLY
          // Generated by GitHub Actions on $(date)
          
          const AVAILABLE_QUIZ = [
          EOL
          
          # Bearbeta alla CSV-filer i data/kategori/
          find data/kategori -name "*.csv" -type f | sort | while read file; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              name="${filename%.csv}"
              
              # Skapa URL-vÃ¤nlig nyckel frÃ¥n filnamn
              key=$(echo "$name" | \
                sed 's/Ã…/A/g; s/Ã¥/a/g; s/Ã„/A/g; s/Ã¤/a/g; s/Ã–/O/g; s/Ã¶/o/g' | \
                tr '[:upper:]' '[:lower:]' | \
                sed 's/[^a-z0-9]/_/g; s/__*/_/g; s/^_//; s/_$//')
              
              # LÃ¤gg till i JS-array
              echo "  {key: '$key', name: '$name', file: '$filename'}," >> js/quiz-links.js
            fi
          done
          
          cat >> js/quiz-links.js << 'EOL'
          ];
          
          // Exportera fÃ¶r anvÃ¤ndning
          if (typeof module !== 'undefined' && module.exports) {
            module.exports = { AVAILABLE_QUIZ };
          }
          EOL
        
      - name: Commit and push changes
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add js/quiz-links.js
          
          # Commit endast om det finns Ã¤ndringar
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ¤– Auto-update quiz links from CSV files"
            git push
          fi
